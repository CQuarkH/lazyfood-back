name: CI/CD Pipeline - LazyFood

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}

jobs:
  # ========================================
  # FASE 1: INTEGRACIÓN CONTINUA (CI)
  # ========================================
  test:
    name: Ejecutar Tests Unitarios
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Construir imagen de Test
        run: docker build -t lazyfood-test -f Dockerfile.test .

      - name: Ejecutar Tests con pytest
        run: docker run --rm lazyfood-test

  # ========================================
  # FASE 2: BUILD Y PUSH DE IMÁGENES
  # ========================================
  build-and-push:
    name: Construir y Publicar Imágenes
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Login en GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Convertir nombre del repo a minúsculas
        id: repo
        run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Build y Push - Backend API
        uses: docker/build-push-action@v5
        with:
          context: ./api
          file: ./api/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/lazyfood-backend:latest

      - name: Build y Push - ML Service (CV)
        uses: docker/build-push-action@v5
        with:
          context: ./cv
          file: ./cv/Dockerfile
          push: true
          tags: ${{ env.REGISTRY }}/${{ steps.repo.outputs.name }}/lazyfood-ml:latest

  # ========================================
  # FASE 3: DESPLIEGUE CONTINUO (CD)
  # ========================================
  deploy:
    name: Desplegar en VPS
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout del código
        uses: actions/checkout@v4

      - name: Convertir nombre del repo a minúsculas
        id: repo
        run: echo "name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Desplegar vía SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            # Navegar al directorio de la aplicación
            cd /opt/lazyfood
            
            # Descargar el docker-compose.prod.yml del repositorio
            curl -o docker-compose.prod.yml https://raw.githubusercontent.com/${{ steps.repo.outputs.name }}/main/docker-compose.prod.yml
            
            # Crear archivo .env con todas las variables sensibles
            cat > .env << 'ENV_EOF'
            ${{ secrets.ENV_FILE }}
            ENV_EOF
            
            # Agregar variables específicas de producción al .env
            echo "DOCKER_REGISTRY=ghcr.io/${{ steps.repo.outputs.name }}" >> .env
            echo "POSTGRES_USER=lazyfood_user" >> .env
            echo "POSTGRES_PASSWORD=lazyfood_pass" >> .env
            echo "POSTGRES_DB=lazyfood_db" >> .env
            
            # Descargar las últimas imágenes
            docker compose -f docker-compose.prod.yml pull
            
            # Detener y eliminar contenedores antiguos
            docker compose -f docker-compose.prod.yml down
            
            # Levantar los servicios con las nuevas imágenes
            docker compose -f docker-compose.prod.yml up -d
            
            # Limpiar imágenes antiguas (opcional)
            docker image prune -f
            
            # Mostrar estado de los contenedores
            docker compose -f docker-compose.prod.yml ps
